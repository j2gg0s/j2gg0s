随着规模的增加, 将机器部署到多个地区的多个机房是必然的选择.

region 是地区, 比如上海和北京, 两个地区的网络延迟相对较高, 稳定性相对较差.

zone 一般指代机房, 比如上海的机房 A 和机房 B.
同地区的多个机房之间网络环境相对可靠, 有些情况下, 可以将同地区的多个机房等同看待.

cluster 指 k8s 集群.
一般而言, 我们允许一个集群分布在同地区的多个机房之间, 但不允许涉及多个地区.
主要是因为地区之间的网络相对较差, 同时也会使得 cluster 变成单点.

所以在多地区多机房的情况下, 我们大多数时候会选择每个地区一个 k8s 集群的多集群方案.

多集群方案中, 不同集群间的 pod 一般而言是无法直接通信的, 主要考虑是:
- 不同地区间的网络未必直接互通, 即使互通, 也需要更严格的安全策略
- 考虑地区间的网络延迟, 应该尽量避免跨地区的网络通信

我们一般会选择在集群边缘建立代理节点, 处理跨集群通信.
此时我们需要讨论的一个重点是: 这种跨集群的调用是否对应用透明.
只有对应用透明, 后续的资源/流量动态调整才是可能的.

以 Istio 提供的多集群能力为例.
我们可以选择在每个集群都部署一个控制面板, 同时监听本集群和其他集群的信息.
应用A 调用应用B 时, 会根据上述获取的多集群信息, 动态确定流量应该分发到哪个实例.
一般而言, 如果本集群有应用 B 的实例, 则尽量避免跨地区, 但是如果本地区没有实例, 则会将请求分发到地区.
同时, 如果本地区的实例大量报错, 触发类似熔断等逻辑, 则请求也会跨地区.
跨地区的请求需要经过特定的边缘节点, 进行加密和转发.

在这个基础上, 我们可以根据资源动态调整某个应用在不同集群部署的数量, 也能在某个地区出现局部/全局故障时自动进行故障转移.

除了无状态服务之间的跨集群通信, 我们还需要考虑有状态服务在多集群下的架构调整.
常见的有状态服务包括 MySQL, Redis, Kafka 等.

一种方案是将其视作全局应用, 所有地区的流量都汇总到一个集群.
缺点是单点风险, 同时因为地区之间的网络限制要求应用对延迟容忍度高, 对带宽要求低.

一种方案是采用主从架构, 写流量都汇总到一个集群, 但是读流量只需要分发到本集群的从库.
要求上层应用能够接受一定程度的数据更新延迟.

一种方案是采用多主架构, 或者说将分布式应用部署在多个集群.
